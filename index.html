<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" href="public/favicon.ico">
  <title></title>
  <!-- 预加载字体和首屏图片 -->
  <link rel="preload" href="public/fonts/LXGWWenKai-Regular.ttf" as="font" type="font/ttf" crossorigin>
  <link rel="preload" href="public/images/1920.jpg" as="image">
  <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
  <link rel="preconnect" href="//cdn.jsdelivr.net">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
  <meta name="description" content="热爱技术，分享知识，记录成长，前端开发博客。">
  <meta name="keywords" content="前端,博客,技术,JavaScript,Vue,React,Node,性能优化">
  <meta name="theme-color" content="#222">
  <meta property="og:title" content="我的博客">
  <meta property="og:description" content="热爱技术，分享知识，记录成长，前端开发博客。">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://wesson2775.github.io/">
  <meta property="og:image" content="public/images/1920.jpg">
</head>

<body>
  <aside class="drawer" id="drawer">
    <div class="drawer-content-group">
      <img src="" alt="头像" class="drawer-avatar" id="drawer-avatar" loading="lazy" style="display:none;">
      <div class="drawer-search">
        <div class="drawer-search-box">
          <svg class="drawer-search-icon" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8" />
            <line x1="21" y1="21" x2="16.65" y2="16.65" />
          </svg>
          <input type="text" placeholder="搜索..." />
        </div>
      </div>
      <nav class="drawer-nav">
        <a href="#" rel="noopener">首页</a>
        <a href="#tags" rel="noopener">标签</a>
        <a href="#links" rel="noopener">友链</a>
        <a href="#about" rel="noopener">关于</a>
      </nav>
    </div>
    <div class="drawer-icons">
      <a href="https://github.com/your-username" title="GitHub" aria-label="GitHub" target="_blank" rel="noopener noreferrer" id="drawer-github">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
          <path d="M12 2C6.48 2 2 6.58 2 12.26c0 4.5 2.87 8.32 6.84 9.67.5.09.68-.22.68-.48 0-.24-.01-.87-.01-1.7-2.78.62-3.37-1.36-3.37-1.36-.45-1.18-1.1-1.5-1.1-1.5-.9-.63.07-.62.07-.62 1 .07 1.53 1.05 1.53 1.05.89 1.56 2.34 1.11 2.91.85.09-.66.35-1.11.63-1.37-2.22-.26-4.56-1.14-4.56-5.07 0-1.12.39-2.03 1.03-2.75-.1-.26-.45-1.3.1-2.7 0 0 .84-.28 2.75 1.05A9.38 9.38 0 0 1 12 6.84c.85.004 1.71.12 2.51.35 1.91-1.33 2.75-1.05 2.75-1.05.55 1.4.2 2.44.1 2.7.64.72 1.03 1.63 1.03 2.75 0 3.94-2.34 4.81-4.57 5.07.36.32.68.94.68 1.9 0 1.37-.01 2.47-.01 2.8 0 .27.18.58.69.48A10.01 10.01 0 0 0 22 12.26C22 6.58 17.52 2 12 2z" />
        </svg>
      </a>
      <a href="mailto:xxx@email.com" title="邮箱" aria-label="邮箱" id="drawer-email" rel="noopener noreferrer nofollow">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="5" width="18" height="14" rx="2" />
          <polyline points="3 7 12 13 21 7" />
        </svg>
      </a>
      <a href="/atom.xml" title="RSS订阅" aria-label="RSS订阅" target="_blank" rel="noopener noreferrer nofollow">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <circle cx="5" cy="19" r="2" fill="currentColor"/>
          <path d="M4 11a8 8 0 0 1 8 8" stroke="currentColor" stroke-width="2" fill="none"/>
          <path d="M4 4a15 15 0 0 1 15 15" stroke="currentColor" stroke-width="2" fill="none"/>
        </svg>
      </a>
    </div>
  </aside>
  <div class="site-content">
    <header class="header">
      <div class="header-content">
        <div class="header-left">
          <img src="" alt="头像" class="avatar" id="header-avatar" loading="lazy" style="display:none;">
          <nav class="nav">
            <a href="#" rel="noopener">首页</a>
            <a href="#tags" rel="noopener">标签</a>
            <a href="#links" rel="noopener">友链</a>
            <a href="#about" rel="noopener">关于</a>
          </nav>
        </div>
        <div class="header-right">
          <div class="search-container"
            style="display: flex; flex-direction: row-reverse; align-items: center; position: relative;">
            <span class="icon search" id="search-toggle" style="visibility: visible;">
              <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8" />
                <line x1="21" y1="21" x2="16.65" y2="16.65" />
              </svg>
            </span>
            <div class="search-box" id="search-box">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8" />
                <line x1="21" y1="21" x2="16.65" y2="16.65" />
              </svg>
              <input type="text" placeholder="搜索..." />
            </div>
          </div>
          <a href="https://github.com/your-username" class="icon github" target="_blank" rel="noopener noreferrer nofollow" id="header-github">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
              <path
                d="M12 2C6.48 2 2 6.58 2 12.26c0 4.5 2.87 8.32 6.84 9.67.5.09.68-.22.68-.48 0-.24-.01-.87-.01-1.7-2.78.62-3.37-1.36-3.37-1.36-.45-1.18-1.1-1.5-1.1-1.5-.9-.63.07-.62.07-.62 1 .07 1.53 1.05 1.53 1.05.89 1.56 2.34 1.11 2.91.85.09-.66.35-1.11.63-1.37-2.22-.26-4.56-1.14-4.56-5.07 0-1.12.39-2.03 1.03-2.75-.1-.26-.45-1.3.1-2.7 0 0 .84-.28 2.75 1.05A9.38 9.38 0 0 1 12 6.84c.85.004 1.71.12 2.51.35 1.91-1.33 2.75-1.05 2.75-1.05.55 1.4.2 2.44.1 2.7.64.72 1.03 1.63 1.03 2.75 0 3.94-2.34 4.81-4.57 5.07.36.32.68.94.68 1.9 0 1.37-.01 2.47-.01 2.8 0 .27.18.58.69.48A10.01 10.01 0 0 0 22 12.26C22 6.58 17.52 2 12 2z" />
            </svg>
          </a>
          <a href="mailto:xxx@email.com" class="icon email" id="header-email" rel="noopener noreferrer nofollow">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="5" width="18" height="14" rx="2" />
              <polyline points="3 7 12 13 21 7" />
            </svg>
          </a>
          <a href="/atom.xml" class="icon rss" title="RSS订阅" aria-label="RSS订阅" target="_blank" rel="noopener noreferrer nofollow">
            <svg viewBox="0 0 24 24" width="20" height="20">
              <circle cx="5" cy="19" r="2" fill="currentColor"/>
              <path d="M4 11a8 8 0 0 1 8 8" stroke="currentColor" stroke-width="2" fill="none"/>
              <path d="M4 4a15 15 0 0 1 15 15" stroke="currentColor" stroke-width="2" fill="none"/>
            </svg>
          </a>
        </div>
      </div>
    </header>

    <!-- 汉堡菜单按钮 -->
    <div class="hamburger-menu" id="hamburger-menu" aria-label="打开菜单">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#ffd700" stroke-width="2.2"
        stroke-linecap="round" stroke-linejoin="round">
        <line x1="4" y1="6" x2="20" y2="6" />
        <line x1="4" y1="12" x2="20" y2="12" />
        <line x1="4" y1="18" x2="20" y2="18" />
      </svg>
    </div>

    <div class="hero-image">
      <div class="hero-center-text">
        <h1 class="hero-title" id="hero-title">我的网站</h1>
        <p class="hero-subtitle" id="hero-subtitle">副标题描述</p>
      </div>
    </div>

    <!-- 标签页界面 -->
    <div class="tags-page" id="tags-page" style="display: none;">
      <div class="tags-container">
        <h2 class="tags-title">标签分类</h2>
        <div class="tags-grid" id="tags-grid">
          <!-- 标签将通过JavaScript动态加载 -->
        </div>
        <div class="tags-articles" id="tags-articles">
          <!-- 按标签筛选的文章将通过JavaScript动态加载 -->
        </div>
        <div class="tags-pagination" id="tags-pagination" style="display: none;">
          <div class="page-list">
            <span class="page-side" id="tags-page-prev-slot"></span>
            <span class="page-center" id="tags-page-center-slot"></span>
            <span class="page-side right" id="tags-page-next-slot"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- 友链页面界面 -->
    <div class="links-page" id="links-page" style="display: none;">
      <div class="links-container">
        <h2 class="links-title">友情链接</h2>
        <ul class="links-list" id="links-list">
          <!-- 友链列表将通过JavaScript动态加载 -->
        </ul>
      </div>
    </div>

    <!-- 关于页面界面 -->
    <div class="about-page" id="about-page" style="display: none;">
      <div class="about-container">
        <div class="about-header">
          <div class="about-avatar">
            <img src="" alt="头像" id="about-avatar" class="avatar" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="avatar-fallback">我</div>
          </div>
          <h1 class="about-name" id="about-name">我的博客</h1>
          <p class="about-bio" id="about-bio">热爱技术，分享知识，记录成长</p>
        </div>

        <div class="about-content">
          <div id="about-md"></div>
        </div>
      </div>
    </div>

    <!-- 文章详情页面界面 -->
    <div class="article-page" id="article-page" style="display: none;">
      <div class="article-container" style="position:relative;">
        <!-- 悬浮目录图标 -->
        <div class="floating-toc-icon" id="floating-toc-icon" style="display:none;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="8" y1="6" x2="21" y2="6"></line>
            <line x1="8" y1="12" x2="21" y2="12"></line>
            <line x1="8" y1="18" x2="21" y2="18"></line>
            <line x1="3" y1="6" x2="3.01" y2="6"></line>
            <line x1="3" y1="12" x2="3.01" y2="12"></line>
            <line x1="3" y1="18" x2="3.01" y2="18"></line>
          </svg>
        </div>
        <div class="article-content">
          <div id="article-md"></div>
          <div id="twikoo"></div>
          <script src="https://cdn.jsdelivr.net/npm/twikoo@1.6.44/dist/twikoo.min.js"></script>
          <script>
            twikoo.init({
              envId: 'https://my-twikoo-nu-lilac.vercel.app/',
              el: '#twikoo',
              region: 'ap-guangzhou',
              lang: 'zh-CN'
            });
          </script>
        </div>
      </div>
    </div>

    <!-- 搜索结果页面界面 -->
    <div class="search-page" id="search-page" style="display: none;">
      <div class="search-container-page">
        <div class="search-header">
          <h2 class="search-title">搜索结果</h2>
          <div class="search-info">
            <span id="search-keyword"></span>
            <span id="search-count"></span>
          </div>
          <div class="search-back">
            <a href="#" id="back-from-search">← 返回首页</a>
          </div>
        </div>
        
        <div class="search-results" id="search-results">
          <!-- 搜索结果将通过JavaScript动态加载 -->
        </div>
        
        <div class="search-pagination" id="search-pagination" style="display: none;">
          <div class="page-list">
            <span class="page-side" id="search-page-prev-slot"></span>
            <span class="page-center" id="search-page-center-slot"></span>
            <span class="page-side right" id="search-page-next-slot"></span>
          </div>
        </div>
      </div>
    </div>

    <div class="main-content" id="main-content">
      <!-- 文章内容将通过JavaScript动态加载 -->
      <div class="post-card">
        <div class="post-summary">正在加载文章，请稍候...</div>
      </div>
    </div>

    <div class="pagination" id="pagination">
      <div class="page-list">
        <span class="page-side" id="page-prev-slot"></span>
        <span class="page-center" id="page-center-slot"></span>
        <span class="page-side right" id="page-next-slot"></span>
      </div>
    </div>

    <footer class="footer">
      <div class="footer-content">
        <span id="footer-title">© 2024 我的博客. 保留所有权利。</span>
      </div>
    </footer>
  </div> <!-- site-content end -->

  <script>
    // 确保DOM完全加载后执行
    document.addEventListener('DOMContentLoaded', function () {

      // 站点配置信息
      let siteConfig = null;

      // MD文件缓存
      const mdCache = new Map();
      
      // 图片懒加载观察器
      let imageObserver = null;

      // 初始化图片懒加载
      function initImageLazyLoading() {
        if ('IntersectionObserver' in window) {
          imageObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                const img = entry.target;
                if (img.dataset.src) {
                  img.src = img.dataset.src;
                  img.removeAttribute('data-src');
                  img.classList.remove('lazy');
                  imageObserver.unobserve(img);
                }
              }
            });
          }, {
            rootMargin: '50px 0px',
            threshold: 0.01
          });
        }
      }

      // 添加图片懒加载
      function addLazyLoading(img) {
        if (imageObserver && img.dataset.src) {
          imageObserver.observe(img);
        }
      }

      // 缓存MD文件内容
      async function fetchWithCache(url) {
        if (mdCache.has(url)) {
          return mdCache.get(url);
        }
        
        try {
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`获取文件失败: ${response.status} ${response.statusText}`);
          }
          const content = await response.text();
          mdCache.set(url, content);
          return content;
        } catch (error) {
          console.error(`获取文件失败 ${url}:`, error);
          throw error;
        }
      }

      // 并行加载站点配置和文章列表
      async function loadSiteConfigAndArticles() {
        try {
          // 并行请求 site.json 和 list.json
          const [siteResponse, listResponse] = await Promise.all([
            fetch('config/site.json'),
            fetch('list.json')
          ]);

          // 检查响应状态
          if (!siteResponse.ok) {
            throw new Error(`获取站点配置失败: ${siteResponse.status} ${siteResponse.statusText}`);
          }
          if (!listResponse.ok) {
            throw new Error(`获取文章列表失败: ${listResponse.status} ${listResponse.statusText}`);
          }

          // 并行解析JSON
          const [siteData, files] = await Promise.all([
            siteResponse.json(),
            listResponse.json()
          ]);

          siteConfig = siteData;
          
          // 更新页面元素
          updateSiteElements();

          // 加载文章内容
          await loadArticlesFromFiles(files);
          
        } catch (error) {
          console.error('加载配置和文章失败:', error);
          // 使用默认配置
          siteConfig = {
            title: '我的博客',
            description: '热爱技术，分享知识，记录成长',
            author: '博主',
            email: 'xxx@email.com',
            siteUrl: 'https://wesson2775.github.io',
            avatar: '头像.png',
            github: 'https://github.com/your-username'
          };
          updateSiteElements();
        }
      }

      // 更新页面元素
      function updateSiteElements() {
        if (!siteConfig) return;

        // 更新头像
        const avatars = ['drawer-avatar', 'header-avatar'];
        avatars.forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            if (siteConfig.avatar && typeof siteConfig.avatar === 'string' && siteConfig.avatar.trim() !== '') {
              // 为头像添加懒加载
              element.dataset.src = siteConfig.avatar;
              element.classList.add('lazy');
              element.alt = siteConfig.author || '头像';
              element.style.display = '';
              addLazyLoading(element);
            } else {
              element.style.display = 'none';
            }
          }
        });

        // 关于页头像支持图片或字符
        function isImageUrl(url) {
          return /\.(png|jpe?g|gif|svg|webp)$/i.test(url) || /^https?:\/\//.test(url);
        }
        const aboutAvatarImg = document.getElementById('about-avatar');
        const aboutAvatarFallback = document.querySelector('.about-avatar .avatar-fallback');
        if (aboutAvatarImg && aboutAvatarFallback) {
          if (isImageUrl(siteConfig.avatar)) {
            aboutAvatarImg.style.display = '';
            // 为关于页头像添加懒加载
            aboutAvatarImg.dataset.src = siteConfig.avatar;
            aboutAvatarImg.classList.add('lazy');
            addLazyLoading(aboutAvatarImg);
            aboutAvatarFallback.style.display = 'none';
          } else {
            aboutAvatarImg.style.display = 'none';
            aboutAvatarFallback.style.display = 'flex';
            aboutAvatarFallback.textContent = siteConfig.avatar || '我';
          }
        }

        // 更新GitHub链接
        const githubLinks = ['drawer-github', 'header-github'];
        githubLinks.forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            element.href = siteConfig.github;
          }
        });

        // 更新邮箱链接
        const emailLinks = ['drawer-email', 'header-email'];
        emailLinks.forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            element.href = `mailto:${siteConfig.email}`;
          }
        });

        // 更新首页标题和副标题
        const heroTitle = document.getElementById('hero-title');
        if (heroTitle) heroTitle.textContent = siteConfig.title;

        const heroSubtitle = document.getElementById('hero-subtitle');
        if (heroSubtitle) heroSubtitle.textContent = siteConfig.description;

        // 更新关于页面信息
        const aboutName = document.getElementById('about-name');
        if (aboutName) aboutName.textContent = siteConfig.title;

        const aboutBio = document.getElementById('about-bio');
        if (aboutBio) aboutBio.textContent = siteConfig.description;

        // 更新页面标题
        document.title = siteConfig.title;

        // 更新页脚标题
        const footerTitle = document.getElementById('footer-title');
        if (footerTitle && siteConfig && siteConfig.title) {
          footerTitle.textContent = `© 2024 ${siteConfig.title}. 保留所有权利。`;
        }
      }

      // 自动加载文章列表
      let allArticles = []; // 存储所有文章
      let articleSummaries = {}; // 文章摘要缓存
      let currentPage = 1; // 当前页码
      const articlesPerPage = 5; // 每页显示5篇文章
      let currentView = 'home'; // 当前视图：'home' 或 'tags' 或 'links' 或 'about'
      let selectedTag = null; // 当前选中的标签
      let tagsCurrentPage = 1; // 标签页当前页码
      let filteredArticles = []; // 筛选后的文章列表
      let linksData = null; // 友链数据
      let searchResults = []; // 搜索结果
      let searchCurrentPage = 1; // 搜索页当前页码
      let currentSearchKeyword = ''; // 当前搜索关键词

      // 文章元信息解析函数
      function parseHtmlMetaAndContent(html) {
        // 提取第一个<h2>标签内容
        const h2Match = html.match(/<h2>([\s\S]*?)<\/h2>/i);
        let meta = { title: '', date: '', tags: '', summary: '' };
        if (h2Match) {
          h2Match[1].split(/\r?\n/).forEach(line => {
            if (line.startsWith('title:')) meta.title = line.replace('title:', '').trim();
            else if (line.startsWith('date:')) meta.date = line.replace('date:', '').trim();
            else if (line.startsWith('tags:')) meta.tags = line.replace('tags:', '').replace(/\[|\]/g, '').split(',').map(t => t.trim()).join(',');
            else if (line.startsWith('summary:')) meta.summary = line.replace('summary:', '').trim();
          });
        }
        // 正文内容：去掉第一个<h2>标签
        const content = html.replace(/<h2>[\s\S]*?<\/h2>/i, '').trim();
        return { ...meta, content };
      }

      // 重写loadArticlesFromFiles
      async function loadArticlesFromFiles(files) {
        try {
          const articlePromises = files.map(async (file) => {
            try {
              const text = await fetchWithCache('articles/' + file);
              const meta = parseHtmlMetaAndContent(text);
              return {
                title: meta.title || file.replace('.html', ''),
                date: meta.date || '',
                tags: meta.tags || '',
                summary: meta.summary || meta.content.slice(0, 120) + (meta.content.length > 120 ? '...' : ''),
                filename: file
              };
            } catch (fileError) {
              console.error(`处理文件 ${file} 时出错:`, fileError);
              return null;
            }
          });
          allArticles = await Promise.all(articlePromises);
          allArticles = allArticles.filter(article => article !== null);
          if (allArticles.length === 0) {
            throw new Error('没有成功加载任何文章');
          }
          allArticles.sort((a, b) => {
            const dateA = new Date(a.date);
            const dateB = new Date(b.date);
            return dateB - dateA;
          });
          renderPage(1);
          renderPagination();
          renderTagsGrid();
          await loadLinks();
          updateAboutStats();
        } catch (error) {
          console.error('加载文章失败:', error);
          document.querySelector('.main-content').innerHTML = `<div class="post-card"><div class="post-summary">文章加载失败: ${error.message}</div></div>`;
        }
      }

      // 修复fetchSummary，优先summary字段，无则正文前100字
      async function fetchSummary(filename) {
        if (articleSummaries[filename]) return articleSummaries[filename];
        try {
          const text = await fetchWithCache('articles/' + filename);
          const meta = parseHtmlMetaAndContent(text);
          let summary = '';
          if (meta.summary && meta.summary.trim()) {
            summary = meta.summary.trim();
          } else {
            // 去除所有HTML标签，仅保留文本
            const plain = meta.content.replace(/<[^>]+>/g, '').replace(/\s+/g, ' ').trim();
            summary = plain.slice(0, 100) + (plain.length > 100 ? '...' : '');
          }
          articleSummaries[filename] = summary;
          return summary;
        } catch (error) {
          console.error(`获取摘要失败 ${filename}:`, error);
          return '摘要加载失败...';
        }
      }

      // 覆盖renderPage函数，实现分页按需加载摘要
      async function renderPage(page) {
        const startIndex = (page - 1) * articlesPerPage;
        const endIndex = startIndex + articlesPerPage;
        const pageArticles = allArticles.slice(startIndex, endIndex);
        // 预加载当前页和下一页摘要
        const preloadFiles = [
          ...pageArticles,
          ...allArticles.slice(endIndex, endIndex + articlesPerPage)
        ].map(a => a.filename);
        await Promise.all(preloadFiles.map(fetchSummary));
        // 渲染当前页
        const container = document.querySelector('.main-content');
        container.innerHTML = '';
        for (const article of pageArticles) {
          const summary = await fetchSummary(article.filename);
          let tagLinks = '';
          if (article.tags) {
            tagLinks = article.tags.split(',').map(tag => `<a href=\"#\" class=\"card-tag-link\" data-tag=\"${tag.trim()}\">${tag.trim()}</a>`).join(', ');
          }
          container.innerHTML += `
            <div class=\"post-card\">
              <div class=\"post-meta\">
                <span class=\"post-title\">${article.title}</span>
                <span class="post-date">${article.date}</span>
                <span class=\"post-tag\">${tagLinks}</span>
              </div>
              <div class=\"post-summary\">${summary}</div>
              <div class=\"post-action\">
                <a href=\"#\" class=\"read-more\" data-filename=\"${article.filename}\">阅读全文</a>
              </div>
            </div>
          `;
        }
        currentPage = page;
        // 依次动画显示卡片
        const cards = document.querySelectorAll('.main-content .post-card');
        cards.forEach((card, i) => {
          card.style.opacity = '0';
          card.style.transform = 'translateY(120px)';
          card.style.transition = 'opacity 0.8s cubic-bezier(0.4,0,0.2,1), transform .8s cubic-bezier(0.4,0,0.2,1)';
        });
        setTimeout(() => {
          cards.forEach((card, i) => {
            setTimeout(() => {
              card.style.opacity = '1';
              card.style.transform = 'translateY(0)';
            }, i * 80);
          });
        }, 80);
      }

      // 渲染分页导航
      function renderPagination() {
        const totalPages = Math.ceil(allArticles.length / articlesPerPage);
        const pagination = document.querySelector('.pagination');
        if (totalPages <= 1) {
          pagination.style.display = 'none';
          return;
        }
        pagination.style.display = 'flex';

        let leftHTML = '';
        let centerHTML = '';
        let rightHTML = '';

        // 上一个按钮（第一页时不渲染）
        if (currentPage > 1) {
          leftHTML = `<a class="page-item page-nav" href="#" data-page="${currentPage - 1}">上一个</a>`;
        } else {
          leftHTML = '';
        }

        // 页码渲染逻辑
        const maxVisiblePages = 5;
        if (totalPages <= maxVisiblePages) {
          for (let i = 1; i <= totalPages; i++) {
            centerHTML += `<a class="page-item ${i === currentPage ? 'active' : ''}" href="#" data-page="${i}">${i}</a>`;
          }
        } else {
          if (currentPage <= 3) {
            for (let i = 1; i <= 4; i++) {
              centerHTML += `<a class="page-item ${i === currentPage ? 'active' : ''}" href="#" data-page="${i}">${i}</a>`;
            }
            centerHTML += '<span class="page-ellipsis">...</span>';
            centerHTML += `<a class="page-item" href="#" data-page="${totalPages}">${totalPages}</a>`;
          } else if (currentPage >= totalPages - 2) {
            centerHTML += `<a class="page-item" href="#" data-page="1">1</a>`;
            centerHTML += '<span class="page-ellipsis">...</span>';
            for (let i = totalPages - 3; i <= totalPages; i++) {
              centerHTML += `<a class="page-item ${i === currentPage ? 'active' : ''}" href="#" data-page="${i}">${i}</a>`;
            }
          } else {
            centerHTML += `<a class="page-item" href="#" data-page="1">1</a>`;
            centerHTML += '<span class="page-ellipsis">...</span>';
            for (let i = currentPage - 1; i <= currentPage + 1; i++) {
              centerHTML += `<a class="page-item ${i === currentPage ? 'active' : ''}" href="#" data-page="${i}">${i}</a>`;
            }
            centerHTML += '<span class="page-ellipsis">...</span>';
            centerHTML += `<a class="page-item" href="#" data-page="${totalPages}">${totalPages}</a>`;
          }
        }

        // 下一个按钮
        if (currentPage < totalPages) {
          rightHTML = `<a class="page-item page-nav" href="#" data-page="${currentPage + 1}">下一个</a>`;
        } else {
          rightHTML = '';
        }

        document.getElementById('page-prev-slot').innerHTML = leftHTML;
        document.getElementById('page-center-slot').innerHTML = centerHTML;
        document.getElementById('page-next-slot').innerHTML = rightHTML;

        // 事件绑定
        pagination.onclick = async function (e) {
          e.preventDefault();
          if (
            e.target.classList.contains('page-item') &&
            !e.target.classList.contains('active') &&
            e.target.hasAttribute('data-page')
          ) {
            const page = parseInt(e.target.getAttribute('data-page'));
            if (page && page !== currentPage) {
              await renderPage(page);
              renderPagination();
              window.scrollTo({ top: 0, behavior: 'smooth' });
            }
          }
        };
      }

      // 渲染标签网格
      function renderTagsGrid() {

        // 收集所有标签
        const tagCounts = {};
        allArticles.forEach(article => {
          if (article.tags) {
            const tags = article.tags.split(',').map(tag => tag.trim());
            tags.forEach(tag => {
              if (tag) {
                tagCounts[tag] = (tagCounts[tag] || 0) + 1;
              }
            });
          }
        });

        // 渲染标签网格
        const tagsGrid = document.getElementById('tags-grid');
        tagsGrid.innerHTML = '';

        Object.entries(tagCounts).forEach(([tag, count], index) => {
          const tagElement = document.createElement('a');
          tagElement.href = '#';
          tagElement.className = 'tag-item';
          tagElement.innerHTML = `
                    ${tag}
                    <span class="tag-count">${count}</span>
                `;
          tagElement.onclick = function (e) {
            e.preventDefault();
            selectTag(tag);
          };
          tagsGrid.appendChild(tagElement);

          // 如果是第一个标签且还没有选中任何标签，自动选择它
          if (index === 0 && !selectedTag) {

            selectTag(tag);
          }
        });
      }

      // 选择标签
      function selectTag(tag) {

        selectedTag = tag;
        tagsCurrentPage = 1; // 重置页码

        // 更新标签项状态
        document.querySelectorAll('.tag-item').forEach(item => {
          item.classList.remove('active');
          if (item.textContent.trim().startsWith(tag)) {
            item.classList.add('active');
          }
        });

        // 筛选文章
        filteredArticles = allArticles.filter(article => {
          if (!article.tags) return false;
          const tags = article.tags.split(',').map(t => t.trim());
          return tags.includes(tag);
        });

        // 渲染第一页
        renderTagsPage(1);
      }

      // 标签页按需加载摘要
      async function renderTagsPage(page) {
        if (!selectedTag || filteredArticles.length === 0) {
          const tagsArticles = document.getElementById('tags-articles');
          tagsArticles.innerHTML = `
                    <h3 class="tags-articles-title">请选择一个标签查看相关文章</h3>
                `;
          tagsArticles.classList.add('show');
          document.getElementById('tags-pagination').style.display = 'none';
          return;
        }
        const startIndex = (page - 1) * articlesPerPage;
        const endIndex = startIndex + articlesPerPage;
        const pageArticles = filteredArticles.slice(startIndex, endIndex);
        // 预加载当前页和下一页摘要
        const preloadFiles = [
          ...pageArticles,
          ...filteredArticles.slice(endIndex, endIndex + articlesPerPage)
        ].map(a => a.filename);
        await Promise.all(preloadFiles.map(fetchSummary));
        const tagsArticles = document.getElementById('tags-articles');
        tagsArticles.innerHTML = `
                <h3 class="tags-articles-title">标签：${selectedTag} (${filteredArticles.length}篇文章)</h3>
            `;
        for (const article of pageArticles) {
          const summary = await fetchSummary(article.filename);
          tagsArticles.innerHTML += `
            <div class="post-card">
                <div class="post-meta">
                    <span class="post-title">${article.title}</span>
                    <span class="post-tag">${article.tags}</span>
                    <span class="post-date">${article.date}</span>
                </div>
                <div class="post-summary">${summary}</div>
                <div class="post-action">
                    <a href="#" class="read-more" data-filename="${article.filename}">阅读全文</a>
                </div>
            </div>
          `;
        }
        tagsArticles.classList.add('show');
        tagsCurrentPage = page;
        renderTagsPagination();
        // 新增动画效果
        const tagCards = document.querySelectorAll('.tags-articles .post-card');
        tagCards.forEach((card, i) => {
          card.style.opacity = '0';
          card.style.transform = 'translateY(120px)';
          card.style.transition = 'opacity 0.8s cubic-bezier(0.4,0,0.2,1), transform .8s cubic-bezier(0.4,0,0.2,1)';
        });
        setTimeout(() => {
          tagCards.forEach((card, i) => {
            setTimeout(() => {
              card.style.opacity = '1';
              card.style.transform = 'translateY(0)';
            }, i * 80);
          });
        }, 80);
      }

      // 渲染标签页分页导航
      function renderTagsPagination() {
        const totalPages = Math.ceil(filteredArticles.length / articlesPerPage);
        const pagination = document.getElementById('tags-pagination');

        if (totalPages <= 1) {
          pagination.style.display = 'none';
          return;
        }
        pagination.style.display = 'flex';

        let leftHTML = '';
        let centerHTML = '';
        let rightHTML = '';

        // 上一个按钮（第一页时不渲染）
        if (tagsCurrentPage > 1) {
          leftHTML = `<a class="page-item page-nav" href="#" data-page="${tagsCurrentPage - 1}">上一个</a>`;
        } else {
          leftHTML = '';
        }

        // 页码渲染逻辑
        const maxVisiblePages = 5;
        if (totalPages <= maxVisiblePages) {
          for (let i = 1; i <= totalPages; i++) {
            centerHTML += `<a class="page-item ${i === tagsCurrentPage ? 'active' : ''}" href="#" data-page="${i}">${i}</a>`;
          }
        } else {
          if (tagsCurrentPage <= 3) {
            for (let i = 1; i <= 4; i++) {
              centerHTML += `<a class="page-item ${i === tagsCurrentPage ? 'active' : ''}" href="#" data-page="${i}">${i}</a>`;
            }
            centerHTML += '<span class="page-ellipsis">...</span>';
            centerHTML += `<a class="page-item" href="#" data-page="${totalPages}">${totalPages}</a>`;
          } else if (tagsCurrentPage >= totalPages - 2) {
            centerHTML += `<a class="page-item" href="#" data-page="1">1</a>`;
            centerHTML += '<span class="page-ellipsis">...</span>';
            for (let i = totalPages - 3; i <= totalPages; i++) {
              centerHTML += `<a class="page-item ${i === tagsCurrentPage ? 'active' : ''}" href="#" data-page="${i}">${i}</a>`;
            }
          } else {
            centerHTML += `<a class="page-item" href="#" data-page="1">1</a>`;
            centerHTML += '<span class="page-ellipsis">...</span>';
            for (let i = tagsCurrentPage - 1; i <= tagsCurrentPage + 1; i++) {
              centerHTML += `<a class="page-item ${i === tagsCurrentPage ? 'active' : ''}" href="#" data-page="${i}">${i}</a>`;
            }
            centerHTML += '<span class="page-ellipsis">...</span>';
            centerHTML += `<a class="page-item" href="#" data-page="${totalPages}">${totalPages}</a>`;
          }
        }

        // 下一个按钮
        if (tagsCurrentPage < totalPages) {
          rightHTML = `<a class="page-item page-nav" href="#" data-page="${tagsCurrentPage + 1}">下一个</a>`;
        } else {
          rightHTML = '';
        }

        document.getElementById('tags-page-prev-slot').innerHTML = leftHTML;
        document.getElementById('tags-page-center-slot').innerHTML = centerHTML;
        document.getElementById('tags-page-next-slot').innerHTML = rightHTML;

        // 事件绑定
        pagination.onclick = async function (e) {
          e.preventDefault();
          if (
            e.target.classList.contains('page-item') &&
            !e.target.classList.contains('active') &&
            e.target.hasAttribute('data-page')
          ) {
            const page = parseInt(e.target.getAttribute('data-page'));
            if (page && page !== tagsCurrentPage) {
              await renderTagsPage(page);
              renderTagsPagination();
              window.scrollTo({ top: 0, behavior: 'smooth' });
            }
          }
        };
      }

      // 切换视图
      function switchView(view) {
        currentView = view;

        if (view === 'home') {
          document.getElementById('tags-page').style.display = 'none';
          document.getElementById('links-page').style.display = 'none';
          document.getElementById('about-page').style.display = 'none';
          document.getElementById('main-content').style.display = 'block';
          document.getElementById('pagination').style.display = 'flex';
          selectedTag = null;
          tagsCurrentPage = 1;
          filteredArticles = [];

          // 重置标签项状态
          document.querySelectorAll('.tag-item').forEach(item => {
            item.classList.remove('active');
          });
          document.getElementById('tags-articles').classList.remove('show');
          document.getElementById('tags-pagination').style.display = 'none';
        } else if (view === 'tags') {
          document.getElementById('tags-page').style.display = 'block';
          document.getElementById('links-page').style.display = 'none';
          document.getElementById('about-page').style.display = 'none';
          document.getElementById('main-content').style.display = 'none';
          document.getElementById('pagination').style.display = 'none';
        } else if (view === 'links') {
          document.getElementById('tags-page').style.display = 'none';
          document.getElementById('links-page').style.display = 'block';
          document.getElementById('about-page').style.display = 'none';
          document.getElementById('main-content').style.display = 'none';
          document.getElementById('pagination').style.display = 'none';

          // 渲染友链页面
          renderLinksPage();
        } else if (view === 'about') {
          document.getElementById('tags-page').style.display = 'none';
          document.getElementById('links-page').style.display = 'none';
          document.getElementById('about-page').style.display = 'block';
          document.getElementById('main-content').style.display = 'none';
          document.getElementById('pagination').style.display = 'none';

          // 更新统计数据
          updateAboutStats();
        }
      }

      // 加载友链数据
      async function loadLinks() {
        try {
          const text = await fetchWithCache('link.md');

          // 解析友链数据
          linksData = parseLinksData(text);

        } catch (error) {
          console.error('加载友链数据失败:', error);
          linksData = { categories: [] };
        }
      }

      // 解析友链数据
      function parseLinksData(text) {
        const lines = text.split('\n');
        const links = [];

        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();

          // 跳过空行和front matter
          if (!line || line.startsWith('---') || line.startsWith('title:') || line.startsWith('description:')) {
            continue;
          }

          // 解析友链项
          if (line.startsWith('- **')) {
            const linkMatch = line.match(/- \*\*(.*?)\*\*/);
            if (linkMatch) {
              const linkTitle = linkMatch[1];
              const link = {
                title: linkTitle,
                url: '',
                description: '',
                avatar: ''
              };

              // 读取后续的属性行
              let j = i + 1;
              while (j < lines.length && lines[j].trim().startsWith('- ')) {
                const attrLine = lines[j].trim();
                if (attrLine.includes('url:')) {
                  link.url = attrLine.split('url:')[1].trim();
                } else if (attrLine.includes('description:')) {
                  link.description = attrLine.split('description:')[1].trim();
                } else if (attrLine.includes('avatar:')) {
                  link.avatar = attrLine.split('avatar:')[1].trim();
                }
                j++;
              }

              links.push(link);
              i = j - 1; // 跳过已处理的行
            }
          }
        }

        return { links };
      }

      // 渲染友链页面
      function renderLinksPage() {
        if (!linksData || !linksData.links) {
          return;
        }

        const linksList = document.getElementById('links-list');
        linksList.innerHTML = '';

        linksData.links.forEach(link => {
          const listItem = document.createElement('li');

          const iconHTML = link.avatar ?
            `<img data-src="${link.avatar}" alt="${link.title}" class="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">` : '';

          const fallbackIcon = `<span>${link.title.charAt(0).toUpperCase()}</span>`;

          listItem.innerHTML = `
                    <a href="${link.url}" class="link-item" target="_blank" rel="noopener noreferrer">
                        <div class="link-icon">
                            ${iconHTML}
                            <div style="display: ${link.avatar ? 'none' : 'flex'}; align-items: center; justify-content: center; width: 100%; height: 100%; font-size: 0.7rem; color: #333; font-weight: bold;">
                                ${fallbackIcon}
                            </div>
                        </div>
                        <div class="link-content">
                            <div class="link-name">${link.title}</div>
                            <div class="link-intro">${link.description}</div>
                        </div>
                    </a>
                `;

          linksList.appendChild(listItem);
          
          // 为友链头像添加懒加载
          const img = listItem.querySelector('img');
          if (img) {
            addLazyLoading(img);
          }
        });
        // 新增动画效果
        const linkCards = document.querySelectorAll('.links-list .link-item');
        linkCards.forEach((card, i) => {
          card.style.opacity = '0';
          card.style.transform = 'translateY(120px)';
          card.style.transition = 'opacity 0.8s cubic-bezier(0.4,0,0.2,1), transform .8s cubic-bezier(0.4,0,0.2,1)';
        });
        setTimeout(() => {
          linkCards.forEach((card, i) => {
            setTimeout(() => {
              card.style.opacity = '1';
              card.style.transform = 'translateY(0)';
            }, i * 80);
          });
        }, 80);
      }

      // 更新关于页面的统计数据
      function updateAboutStats() {
        // 检查文章数据是否已加载
        if (!allArticles || allArticles.length === 0) {
          return;
        }

        // 文章总数
        const totalPostsElement = document.getElementById('total-posts');
        if (totalPostsElement) {
          totalPostsElement.textContent = allArticles.length;
        }

        // 标签分类数
        const tagCounts = {};
        allArticles.forEach(article => {
          if (article.tags) {
            const tags = article.tags.split(',').map(tag => tag.trim());
            tags.forEach(tag => {
              if (tag) {
                tagCounts[tag] = (tagCounts[tag] || 0) + 1;
              }
            });
          }
        });
        const totalTagsElement = document.getElementById('total-tags');
        if (totalTagsElement) {
          totalTagsElement.textContent = Object.keys(tagCounts).length;
        }

        // 友链数量
        const totalLinks = linksData && linksData.links ? linksData.links.length : 0;
        const totalLinksElement = document.getElementById('total-links');
        if (totalLinksElement) {
          totalLinksElement.textContent = totalLinks;
        }
      }

      // 加载并渲染关于页面Markdown
      async function renderAboutMarkdown() {
        try {
          const md = await fetchWithCache('about.md');
          // 使用marked.js解析markdown
          if (window.marked) {
            document.getElementById('about-md').innerHTML = window.marked.parse(md);
          } else {
            document.getElementById('about-md').innerText = md;
          }
        } catch (e) {
          document.getElementById('about-md').innerText = '加载关于内容失败';
        }
      }

      // 重写renderArticleDetail
      async function renderArticleDetail(filename) {
        try {
          const article = allArticles.find(a => a.filename === filename);
          if (!article) {
            throw new Error('文章不存在');
          }
          const text = await fetchWithCache('articles/' + filename);
          const meta = parseHtmlMetaAndContent(text);
          // 渲染正文（第一个<h1>及其后内容）
          document.getElementById('article-md').innerHTML = meta.content;
          showPage('article');
          updateHeroTitle('article', meta.title);
          const heroSubtitle = document.querySelector('.hero-subtitle');
          if (heroSubtitle) {
            let tagText = meta.tags ? `${meta.tags}` : '';
            let dateText = meta.date ? `${meta.date}` : '';
            heroSubtitle.textContent = [tagText, dateText].filter(Boolean).join(' / ');
          }
          // 目录功能可选保留或移除
        } catch (e) {
          console.error('加载文章详情失败:', e);
          document.getElementById('article-md').innerText = '加载文章内容失败';
        }
      }

      // 全局点击事件，优先处理阅读全文和标签点击
      document.addEventListener('click', function(e) {
        // 1. 处理阅读全文按钮
        if (e.target.classList.contains('read-more')) {
          e.preventDefault();
          const filename = e.target.getAttribute('data-filename');
          if (filename) {
            renderArticleDetail(filename);
          }
          return;
        }
        // 2. 处理文章详情页标签点击
        if (e.target.classList.contains('article-tag-link')) {
          e.preventDefault();
          const tag = e.target.getAttribute('data-tag');
          if (tag) {
            showPage('tags');
            setTimeout(() => selectTag(tag), 0);
          }
          return;
        }
        // 3. 处理文章卡片标签点击
        if (e.target.classList.contains('card-tag-link')) {
          e.preventDefault();
          const tag = e.target.getAttribute('data-tag');
          if (tag) {
            showPage('tags');
            setTimeout(() => selectTag(tag), 0);
          }
          return;
        }
      });

     

      // 绑定搜索结果页面返回按钮
      document.getElementById('back-from-search').addEventListener('click', function(e) {
        e.preventDefault();
        showPage('home');
      });

      // 绑定搜索框事件
      function bindSearchEvents() {
        const searchBox = document.getElementById('search-box');
        const searchInput = searchBox.querySelector('input');
        const searchIcon = searchBox.querySelector('svg');
        
        // 搜索图标点击事件
        searchIcon.addEventListener('click', function() {
          const keyword = searchInput.value.trim();
          if (keyword) {
            performSearch(keyword);
          }
        });
        
        // 回车键搜索
        searchInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            const keyword = searchInput.value.trim();
            if (keyword) {
              performSearch(keyword);
            }
          }
        });
        
        // 抽屉菜单搜索框
        const drawerSearchBox = document.querySelector('.drawer-search-box');
        const drawerSearchInput = drawerSearchBox ? drawerSearchBox.querySelector('input') : null;
        const drawerSearchIcon = drawerSearchBox ? drawerSearchBox.querySelector('svg') : null;
        if (drawerSearchInput) {
          drawerSearchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
              const keyword = this.value.trim();
              if (keyword) {
                performSearch(keyword);
              }
            }
          });
        }
        if (drawerSearchIcon && drawerSearchInput) {
          drawerSearchIcon.addEventListener('click', function() {
            const keyword = drawerSearchInput.value.trim();
            if (keyword) {
              performSearch(keyword);
            }
          });
        }
      }
      
      // 初始化搜索事件
      bindSearchEvents();

      // 监听页面切换到关于页面时渲染
      function showAboutPage() {
        document.getElementById('about-page').style.display = 'block';
        document.getElementById('main-content').style.display = 'none';
        document.getElementById('pagination').style.display = 'none';
        renderAboutMarkdown();
      }
      // 假设有导航按钮，绑定事件
      const aboutNav = document.querySelector('.nav a[href="#about"]');
      if (aboutNav) {
        aboutNav.addEventListener('click', function (e) {
          e.preventDefault();
          showAboutPage();
        });
      }

      // 页面加载时自动加载配置和文章
      // 初始化图片懒加载
      initImageLazyLoading();
      
      // 加载站点配置和文章
      loadSiteConfigAndArticles();

      // 导航栏事件处理
      document.querySelectorAll('.nav a').forEach(link => {
        link.addEventListener('click', function (e) {
          e.preventDefault();
          const text = this.textContent.trim();

          if (text === '标签') {
            switchView('tags');
          } else if (text === '友链') {
            switchView('links');
          } else if (text === '关于') {
            switchView('about');
          } else if (text === '首页') {
            switchView('home');
          }
          // 其他导航项可以在这里添加
        });
      });

      // 侧边栏导航事件处理
      document.querySelectorAll('.drawer-nav a').forEach(link => {
        link.addEventListener('click', function (e) {
          e.preventDefault();
          const text = this.textContent.trim();

          if (text === '标签') {
            switchView('tags');
            // 关闭侧边栏
            document.getElementById('drawer').classList.remove('open');
            document.body.classList.remove('drawer-open');
          } else if (text === '友链') {
            switchView('links');
            // 关闭侧边栏
            document.getElementById('drawer').classList.remove('open');
            document.body.classList.remove('drawer-open');
          } else if (text === '关于') {
            switchView('about');
            // 关闭侧边栏
            document.getElementById('drawer').classList.remove('open');
            document.body.classList.remove('drawer-open');
          } else if (text === '首页') {
            switchView('home');
            // 关闭侧边栏
            document.getElementById('drawer').classList.remove('open');
            document.body.classList.remove('drawer-open');
          }
          // 其他导航项可以在这里添加
        });
      });

      const searchToggle = document.getElementById('search-toggle');
      const searchBox = document.getElementById('search-box');
      const searchInput = searchBox.querySelector('input');

      if (searchToggle && searchBox) {
        searchToggle.onclick = function (event) {
          searchToggle.style.visibility = 'hidden';
          searchBox.classList.add('open');
          setTimeout(() => {
            searchInput.focus();
          }, 300);
          event.stopPropagation();
        };

        document.addEventListener('click', function (e) {
          if (searchBox.classList.contains('open')) {
            if (!searchBox.contains(e.target)) {
              searchBox.classList.remove('open');
              setTimeout(() => {
                searchToggle.style.visibility = 'visible';
              }, 300);
            }
          }
        });
      }

      function updateHeroParallax() {
        const hero = document.querySelector('.hero-image');
        if (!hero) return;
        const winW = window.innerWidth;
        // 以1920为基准，窗口越窄图片越大，越宽图片越小，范围[100%, 120%]
        const scale = Math.max(1, Math.min(1.2, 1920 / winW));
        hero.style.backgroundSize = `${scale * 100}% auto`;
      }
      window.addEventListener('resize', updateHeroParallax);
      updateHeroParallax(); // 初始调用

      // 移动端汉堡菜单与抽屉交互
      const hamburgerMenu = document.getElementById('hamburger-menu');
      const drawer = document.getElementById('drawer');
      let drawerMask = document.getElementById('drawer-mask');
      if (!drawerMask) {
        drawerMask = document.createElement('div');
        drawerMask.id = 'drawer-mask';
        drawerMask.className = 'drawer-mask';
        drawerMask.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.15);z-index:1999;display:none;';
        document.body.appendChild(drawerMask);
      }
      function setDrawerOpen(open) {
        if (open) {
          // 互斥：打开移动菜单时自动关闭目录
          document.body.classList.remove('toc-open');
          let tocDrawer = document.getElementById('toc-drawer');
          if (tocDrawer) tocDrawer.classList.remove('open');
          let tocMask = document.getElementById('toc-mask');
          if (tocMask) tocMask.classList.remove('open');
          drawer.classList.add('open');
          document.body.classList.add('drawer-open');
          drawerMask.classList.add('open');
          drawerMask.style.display = 'block';
        } else {
          drawer.classList.remove('open');
          document.body.classList.remove('drawer-open');
          drawerMask.classList.remove('open');
          drawerMask.style.display = 'none';
        }
      }

      let drawerOpenState = false;
      if (hamburgerMenu && drawer) {
        hamburgerMenu.addEventListener('click', function (e) {
          drawerOpenState = !drawerOpenState;
          setDrawerOpen(drawerOpenState);
          e.stopPropagation();
        });
        // 点击遮罩关闭移动菜单
        drawerMask.onclick = function() {
          drawerOpenState = false;
          setDrawerOpen(false);
        };
        document.addEventListener('click', function (e) {
          if (drawer.classList.contains('open')) {
            // 如果点击发生在drawer内部，不关闭
            if (drawer.contains(e.target)) return;
            drawerOpenState = false;
            setDrawerOpen(false);
          }
        });
        window.addEventListener('resize', function () {
          if (window.innerWidth > 768) setDrawerOpen(false);
        });
      }

      // 汉堡菜单随页面滚动隐藏
      window.addEventListener('scroll', function () {
        var hamburger = document.getElementById('hamburger-menu');
        if (!hamburger) return;

        if (window.scrollY > 307) {
          hamburger.classList.add('hamburger-hidden');

        } else {
          hamburger.classList.remove('hamburger-hidden');

        }
      });

      // 更新 hero 区域标题
      function updateHeroTitle(view, articleTitle = '') {
        const heroTitle = document.querySelector('.hero-title');
        const heroSubtitle = document.querySelector('.hero-subtitle');
        
        switch(view) {
          case 'home':
            heroTitle.textContent = siteConfig ? siteConfig.title : '我的博客';
            heroSubtitle.textContent = siteConfig ? siteConfig.description : '热爱技术，分享知识，记录成长';
            break;
          case 'tags':
            heroTitle.textContent = '标签分类';
            heroSubtitle.textContent = '';
            break;
          case 'links':
            heroTitle.textContent = '友情链接';
            heroSubtitle.textContent = '';
            break;
          case 'about':
            heroTitle.textContent = '关于';
            heroSubtitle.textContent = '';
            break;
          case 'article':
            heroTitle.textContent = articleTitle || '文章详情';
            heroSubtitle.textContent = '';
            break;
          case 'search':
            heroTitle.textContent = articleTitle || '搜索结果';
            heroSubtitle.textContent = '';
            break;
          default:
            heroTitle.textContent = siteConfig ? siteConfig.title : '我的博客';
            heroSubtitle.textContent = siteConfig ? siteConfig.description : '热爱技术，分享知识，记录成长';
        }
      }

      // 页面切换函数
      function showPage(view) {
        document.getElementById('main-content').style.display = (view === 'home') ? 'block' : 'none';
        document.getElementById('pagination').style.display = (view === 'home') ? 'flex' : 'none';
        document.getElementById('tags-page').style.display = (view === 'tags') ? 'block' : 'none';
        document.getElementById('links-page').style.display = (view === 'links') ? 'block' : 'none';
        document.getElementById('about-page').style.display = (view === 'about') ? 'block' : 'none';
        document.getElementById('article-page').style.display = (view === 'article') ? 'block' : 'none';
        document.getElementById('search-page').style.display = (view === 'search') ? 'block' : 'none';
        
        // 新增：切换body的home类
        if (view === 'home') {
          document.body.classList.add('home');
        } else {
          document.body.classList.remove('home');
        }
        // 更新 hero 区域标题
        updateHeroTitle(view);
        
        if (view === 'about') renderAboutMarkdown();
      }
      // 绑定所有导航
      [...document.querySelectorAll('.nav a, .drawer-nav a')].forEach(a => {
        a.addEventListener('click', function (e) {
          const hash = a.getAttribute('href');
          if (hash.startsWith('#')) {
            e.preventDefault();
            if (hash === '#about') showPage('about');
            else if (hash === '#tags') showPage('tags');
            else if (hash === '#links') showPage('links');
            else showPage('home');
          }
        });
      });
      // 默认显示主页
      showPage('home');

      // 搜索功能
      async function performSearch(keyword) {
        if (!keyword.trim()) {
          return;
        }
        
        currentSearchKeyword = keyword.trim();
        searchResults = [];
        
        // 显示搜索页面和加载状态
        showPage('search');
        updateHeroTitle('search', `搜索: ${keyword}`);
        
        const container = document.getElementById('search-results');
        const keywordSpan = document.getElementById('search-keyword');
        const countSpan = document.getElementById('search-count');
        
        // 显示加载状态
        keywordSpan.textContent = `关键词: "${currentSearchKeyword}"`;
        countSpan.textContent = '正在搜索...';
        container.innerHTML = '<div class="search-loading">正在搜索文章内容，请稍候...</div>';
        
        // 搜索文章标题、日期、标签和完整内容
        for (const article of allArticles) {
          let hasMatch = false;
          let searchSnippet = '';
          
          // 检查标题、日期、标签
          const metaText = `${article.title} ${article.date} ${article.tags}`.toLowerCase();
          const keywordLower = keyword.toLowerCase();
          
          if (metaText.includes(keywordLower)) {
            hasMatch = true;
          }
          
          // 加载完整文章内容进行搜索
          try {
            const res = await fetch('articles/' + article.filename);
            const text = await res.text();
            
            // 解析 front matter
            const match = text.match(/^---([\s\S]*?)---/);
            let content = text;
            if (match) {
              content = text.slice(match[0].length).trim();
            }
            
            // 在完整内容中搜索关键词
            const contentLower = content.toLowerCase();
            const keywordIndex = contentLower.indexOf(keywordLower);
            
            if (keywordIndex !== -1) {
              hasMatch = true;
              
              // 提取包含关键词的上下文片段（前后各150字）
              const start = Math.max(0, keywordIndex - 150);
              const end = Math.min(content.length, keywordIndex + keyword.length + 150);
              searchSnippet = content.substring(start, end);
              
              // 如果片段不是从开头开始，添加省略号
              if (start > 0) {
                searchSnippet = '...' + searchSnippet;
              }
              if (end < content.length) {
                searchSnippet = searchSnippet + '...';
              }
            }
          } catch (error) {
            console.error('加载文章内容失败:', error);
          }
          
          if (hasMatch) {
            searchResults.push({
              ...article,
              searchSnippet: searchSnippet || article.summary
            });
          }
        }
        
        // 按时间排序搜索结果
        searchResults.sort((a, b) => {
          const dateA = new Date(a.date);
          const dateB = new Date(b.date);
          return dateB - dateA;
        });
        
        // 显示搜索结果
        searchCurrentPage = 1;
        renderSearchResults(1);
      }

      // 高亮关键词函数
      function highlightKeyword(text, keyword) {
        if (!keyword || !text) return text;
        
        const regex = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
        return text.replace(regex, '<mark class="search-highlight">$1</mark>');
      }

      // 搜索页按需加载摘要
      async function renderSearchResults(page) {
        const startIndex = (page - 1) * articlesPerPage;
        const endIndex = startIndex + articlesPerPage;
        const pageResults = searchResults.slice(startIndex, endIndex);
        // 预加载当前页和下一页摘要
        const preloadFiles = [
          ...pageResults,
          ...searchResults.slice(endIndex, endIndex + articlesPerPage)
        ].map(a => a.filename);
        await Promise.all(preloadFiles.map(fetchSummary));
        const container = document.getElementById('search-results');
        const keywordSpan = document.getElementById('search-keyword');
        const countSpan = document.getElementById('search-count');
        keywordSpan.textContent = `关键词: "${currentSearchKeyword}"`;
        countSpan.textContent = `找到 ${searchResults.length} 篇文章`;
        container.innerHTML = '';
        if (searchResults.length === 0) {
          container.innerHTML = `
            <div class="search-no-results">
              <p>没有找到包含 "${currentSearchKeyword}" 的文章</p>
              <p>请尝试其他关键词</p>
            </div>
          `;
          document.getElementById('search-pagination').style.display = 'none';
          return;
        }
        for (const article of pageResults) {
          const summary = await fetchSummary(article.filename);
          // 高亮关键词
          const highlightedTitle = highlightKeyword(article.title, currentSearchKeyword);
          const highlightedTags = highlightKeyword(article.tags, currentSearchKeyword);
          const highlightedDate = highlightKeyword(article.date, currentSearchKeyword);
          const highlightedSnippet = highlightKeyword(summary, currentSearchKeyword);
          container.innerHTML += `
            <div class="post-card">
              <div class="post-meta">
                <span class="post-title">${highlightedTitle}</span>
                <span class="post-tag">${highlightedTags}</span>
                <span class="post-date">${highlightedDate}</span>
              </div>
              <div class="post-summary">
                ${highlightedSnippet}
              </div>
              <div class="post-action">
                <a href="#" class="read-more" data-filename="${article.filename}">阅读全文</a>
              </div>
            </div>
          `;
        }
        renderSearchPagination();
      }

      // 渲染搜索分页
      function renderSearchPagination() {
        const totalPages = Math.ceil(searchResults.length / articlesPerPage);
        const pagination = document.getElementById('search-pagination');
        
        if (totalPages <= 1) {
          pagination.style.display = 'none';
          return;
        }
        
        pagination.style.display = 'flex';
        
        let leftHTML = '';
        let centerHTML = '';
        let rightHTML = '';

        // 上一个按钮
        if (searchCurrentPage > 1) {
          leftHTML = `<a class="page-item page-nav" href="#" data-page="${searchCurrentPage - 1}">上一个</a>`;
        }

        // 页码渲染逻辑
        const maxVisiblePages = 5;
        if (totalPages <= maxVisiblePages) {
          for (let i = 1; i <= totalPages; i++) {
            centerHTML += `<a class="page-item ${i === searchCurrentPage ? 'active' : ''}" href="#" data-page="${i}">${i}</a>`;
          }
        } else {
          if (searchCurrentPage <= 3) {
            for (let i = 1; i <= 4; i++) {
              centerHTML += `<a class="page-item ${i === searchCurrentPage ? 'active' : ''}" href="#" data-page="${i}">${i}</a>`;
            }
            centerHTML += '<span class="page-ellipsis">...</span>';
            centerHTML += `<a class="page-item" href="#" data-page="${totalPages}">${totalPages}</a>`;
          } else if (searchCurrentPage >= totalPages - 2) {
            centerHTML += `<a class="page-item" href="#" data-page="1">1</a>`;
            centerHTML += '<span class="page-ellipsis">...</span>';
            for (let i = totalPages - 3; i <= totalPages; i++) {
              centerHTML += `<a class="page-item ${i === searchCurrentPage ? 'active' : ''}" href="#" data-page="${i}">${i}</a>`;
            }
          } else {
            centerHTML += `<a class="page-item" href="#" data-page="1">1</a>`;
            centerHTML += '<span class="page-ellipsis">...</span>';
            for (let i = searchCurrentPage - 1; i <= searchCurrentPage + 1; i++) {
              centerHTML += `<a class="page-item ${i === searchCurrentPage ? 'active' : ''}" href="#" data-page="${i}">${i}</a>`;
            }
            centerHTML += '<span class="page-ellipsis">...</span>';
            centerHTML += `<a class="page-item" href="#" data-page="${totalPages}">${totalPages}</a>`;
          }
        }

        // 下一个按钮
        if (searchCurrentPage < totalPages) {
          rightHTML = `<a class="page-item page-nav" href="#" data-page="${searchCurrentPage + 1}">下一个</a>`;
        } else {
          rightHTML = '';
        }

        document.getElementById('search-page-prev-slot').innerHTML = leftHTML;
        document.getElementById('search-page-center-slot').innerHTML = centerHTML;
        document.getElementById('search-page-next-slot').innerHTML = rightHTML;

        // 事件绑定
        pagination.onclick = async function (e) {
          e.preventDefault();
          if (
            e.target.classList.contains('page-item') &&
            !e.target.classList.contains('active') &&
            e.target.hasAttribute('data-page')
          ) {
            const page = parseInt(e.target.getAttribute('data-page'));
            if (page && page !== searchCurrentPage) {
              searchCurrentPage = page;
              await renderSearchResults(page);
              window.scrollTo({ top: 0, behavior: 'smooth' });
            }
          }
        };
      }
    });

    (function () {
      // 只在桌面端生效
      if (/Mobi|Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent)) return;

      let isScrolling = false;
      let velocity = 0;

      function animateScroll() {
        if (Math.abs(velocity) < 0.1) {
          isScrolling = false;
          velocity = 0;
          return;
        }
        window.scrollBy(0, velocity);
        velocity *= 0.88  ; // 摩擦力更大，惯性更快消失
        requestAnimationFrame(animateScroll);
      }

      window.addEventListener('wheel', function (e) {
        if (e.ctrlKey || e.metaKey || e.altKey) return;
        if (e.defaultPrevented) return;

        e.preventDefault();

        velocity += e.deltaY * 0.3; // 叠加更小
        velocity = Math.max(Math.min(velocity, 30), -30); // 最大速度更小

        if (!isScrolling) {
          isScrolling = true;
          animateScroll();
        }
      }, { passive: false });
    })();
  </script>
</body>

</html>